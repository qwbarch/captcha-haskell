<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Custom monad · captcha-haskell</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='root'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/warnOldVersion.js"></script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>captcha-haskell
</a>
<div class="version-number">
0.1.0.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="solving-captchas.html" class="page">Solving captchas</a></li>
  <li><a href="custom-monad.html" class="active page">Custom monad</a></li>
  <li><a href="running-tests.html" class="page">Running tests</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html">captcha-haskell</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>captcha-haskell
</a>
<div class="version-number">
0.1.0.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="solving-captchas.html" class="page">Solving captchas</a></li>
  <li><a href="custom-monad.html" class="active page">Custom monad</a></li>
  <li><a href="running-tests.html" class="page">Running tests</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">captcha-haskell</a></li>
  <li>Custom monad</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#custom-monad" name="custom-monad" class="anchor"><span class="anchor-link"></span></a>Custom monad</h1>
<p>This section shows how to use a custom monad transformer stack with the <code>captcha-haskell</code> package.</p>
<p>To satisfy <code>MonadCaptcha</code>, a tiny amount of boilerplate is required by providing an instance of <code>HasCaptchaEnv</code>.<br/>We will provide this instance with the help of the lens <a href="https://hackage.haskell.org/package/lens">lens</a> package.</p>
<p>Here are the required imports and language extensions for the example below:</p>
<pre class="prettyprint"><code class="language-haskell">{-# LANGUAGE GeneralizedNewtypeDeriving #-}
{-# LANGUAGE LambdaCase #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE TypeApplications #-}
{-# LANGUAGE StrictData #-}

import Captcha (CaptchaEnv, HasCaptchaEnv (captchaEnv), ImageCaptcha, MonadCaptcha (solve), mkCaptchaEnv)
import Captcha.TwoCaptcha (TwoCaptcha)
import Control.Exception (throw)
import Control.Lens.TH (makeClassy)
import Control.Monad.Reader (MonadReader, ReaderT (runReaderT))
import Data.Default (Default (def))
import UnliftIO (MonadIO, MonadUnliftIO)
</code></pre>
<p>A minimal <code>AppM</code> using <a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Reader.html#g:3">ReaderT</a> to pass its environment <code>AppEnv</code> around implicitly:</p>
<pre class="prettyprint"><code class="language-haskell">newtype AppM a = AppM
  { unAppM :: ReaderT AppEnv IO a
  }
  deriving
    ( Applicative,
      Functor,
      Monad,
      MonadIO,
      MonadUnliftIO,
      MonadReader AppEnv
    )
</code></pre>
<p>Here is a minimal <code>AppEnv</code> to make your <code>AppM</code> satisfy <code>MonadCaptcha</code>:</p>
<pre class="prettyprint"><code class="language-haskell">data AppEnv = AppEnv
  { _appCaptchaEnv :: CaptchaEnv
  }

makeClassy &#39;&#39;AppEnv

instance HasCaptchaEnv AppEnv where
  captchaEnv = appCaptchaEnv
</code></pre>
<p>Now you&rsquo;ll be able to use solve captchas from within your <code>AppM</code>:</p>
<pre class="prettyprint"><code class="language-haskell">main :: IO ()
main = do
  let captcha = def @ImageCaptcha
  captchaEnv &lt;- mkCaptchaEnv
  runAppM (solve @TwoCaptcha captcha) (AppEnv captchaEnv) &gt;&gt;= \case
    Right result -&gt; print result
    Left exception -&gt; throw exception
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Notice the <code>HasCaptchaEnv</code> instance, this boilerplate is required.</p></div>
<div class="nav-next">
<p><strong>Next:</strong> <a href="running-tests.html">Running tests</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2022</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.1.0.0', '')});</script>


</html>
